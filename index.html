<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caffeine Intake Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border-color: #e2e8f0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --safe-green: #48bb78;
            --safe-blue: #4299e1;
            --warning-orange: #ed8936;
            --danger-red: #f56565;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
            align-items: start;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        select, input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
            font-family: inherit;
            min-height: 44px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            min-height: 44px;
            width: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: var(--danger-red);
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .result-card.safe-green {
            border-color: var(--safe-green);
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1), rgba(72, 187, 120, 0.05));
        }

        .result-card.safe-blue {
            border-color: var(--safe-blue);
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(66, 153, 225, 0.05));
        }

        .result-card.warning-orange {
            border-color: var(--warning-orange);
            background: linear-gradient(135deg, rgba(237, 137, 54, 0.1), rgba(237, 137, 54, 0.05));
        }

        .result-card.danger-red {
            border-color: var(--danger-red);
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1), rgba(245, 101, 101, 0.05));
        }

        .result-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .result-unit {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .warning-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .warning-info {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(66, 153, 225, 0.05));
            border-left: 4px solid var(--safe-blue);
            color: #2c5282;
        }

        .warning-caution {
            background: linear-gradient(135deg, rgba(237, 137, 54, 0.1), rgba(237, 137, 54, 0.05));
            border-left: 4px solid var(--warning-orange);
            color: #c05621;
        }

        .warning-alert {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1), rgba(245, 101, 101, 0.05));
            border-left: 4px solid var(--danger-red);
            color: #c53030;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .custom-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 6px;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .legend-item:hover {
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .legend-item.hidden {
            opacity: 0.4;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .drink-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .drink-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .drink-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
        }

        .drink-info {
            flex: 1;
        }

        .drink-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .drink-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .result-value {
                font-size: 1.5rem;
            }

            .card {
                padding: 20px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .chart-container {
                height: 250px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .drink-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .btn-danger {
                width: 100%;
            }

            .custom-legend {
                padding: 10px;
                gap: 10px;
            }

            .legend-item {
                font-size: 0.8rem;
                padding: 3px 8px;
            }
        }

        @media (max-width: 375px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 15px;
            }

            .result-value {
                font-size: 1.3rem;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .updating {
            animation: pulse 1s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>☕ Caffeine Intake Calculator</h1>
            <p>Track your caffeine consumption and monitor its effects throughout the day</p>
        </div>

        <div class="main-grid">
            <div class="sidebar">
                <div class="card">
                    <h2 class="card-title">📝 Add Caffeine</h2>
                    
                    <div class="form-group">
                        <label for="drinkSelect">Select Drink</label>
                        <select id="drinkSelect">
                            <optgroup label="Coffee - Starbucks">
                                <option value="310">Starbucks Pike Place Roast - Grande (16 oz) - 310mg</option>
                                <option value="260">Starbucks Blonde Roast - Grande (16 oz) - 260mg</option>
                                <option value="150">Starbucks Americano - Grande (16 oz) - 150mg</option>
                                <option value="150">Starbucks Latte - Grande (16 oz) - 150mg</option>
                                <option value="150">Starbucks Cappuccino - Grande (16 oz) - 150mg</option>
                                <option value="75">Starbucks Espresso Shot - Single - 75mg</option>
                            </optgroup>
                            <optgroup label="Coffee - Costa Coffee">
                                <option value="277">Costa Americano - Medium - 277mg</option>
                                <option value="277">Costa Latte - Medium - 277mg</option>
                                <option value="277">Costa Cappuccino - Medium - 277mg</option>
                                <option value="185">Costa Flat White - Medium - 185mg</option>
                            </optgroup>
                            <optgroup label="Coffee - Dunkin'">
                                <option value="210">Dunkin' Coffee - Medium (14 oz) - 210mg</option>
                                <option value="180">Dunkin' Americano - Medium - 180mg</option>
                                <option value="166">Dunkin' Latte - Medium - 166mg</option>
                            </optgroup>
                            <optgroup label="Coffee - Generic">
                                <option value="95">Brewed Coffee - 8 oz - 95mg</option>
                                <option value="63">Espresso - 1 oz - 63mg</option>
                                <option value="47">Instant Coffee - 8 oz - 47mg</option>
                                <option value="2">Decaf Coffee - 8 oz - 2mg</option>
                            </optgroup>
                            <optgroup label="Energy Drinks">
                                <option value="300">Bang Energy - 16 oz - 300mg</option>
                                <option value="300">Reign Total Body Fuel - 16 oz - 300mg</option>
                                <option value="160">Monster Energy - 16 oz - 160mg</option>
                                <option value="160">Rockstar Energy - 16 oz - 160mg</option>
                                <option value="80">Red Bull - 8.4 oz - 80mg</option>
                                <option value="200">5-hour Energy - 2 oz - 200mg</option>
                                <option value="242">Monster Ultra - 16 oz - 142mg</option>
                            </optgroup>
                            <optgroup label="Tea">
                                <option value="47">Black Tea - 8 oz - 47mg</option>
                                <option value="28">Green Tea - 8 oz - 28mg</option>
                                <option value="25">White Tea - 8 oz - 25mg</option>
                                <option value="70">Matcha - 8 oz - 70mg</option>
                                <option value="50">Chai Latte - 8 oz - 50mg</option>
                                <option value="40">Iced Tea - 8 oz - 40mg</option>
                            </optgroup>
                            <optgroup label="Soft Drinks">
                                <option value="34">Coca-Cola - 12 oz - 34mg</option>
                                <option value="46">Diet Coke - 12 oz - 46mg</option>
                                <option value="38">Pepsi - 12 oz - 38mg</option>
                                <option value="36">Diet Pepsi - 12 oz - 36mg</option>
                                <option value="54">Mountain Dew - 12 oz - 54mg</option>
                                <option value="41">Dr Pepper - 12 oz - 41mg</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="200">Caffeine Pill - 200mg</option>
                                <option value="100">Dark Chocolate - 1 oz - 12mg</option>
                                <option value="custom">Custom Amount</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group hidden" id="customAmountGroup">
                        <label for="customAmount">Caffeine Amount (mg)</label>
                        <input type="number" id="customAmount" min="0" max="1000" placeholder="Enter caffeine in mg">
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <select id="quantity">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Consumption Time</label>
                        <div class="time-selectors">
                            <select id="consumptionDay">
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                            </select>
                            <select id="consumptionTime">
                                <option value="00:00">12:00 AM</option>
                                <option value="01:00">1:00 AM</option>
                                <option value="02:00">2:00 AM</option>
                                <option value="03:00">3:00 AM</option>
                                <option value="04:00">4:00 AM</option>
                                <option value="05:00">5:00 AM</option>
                                <option value="06:00">6:00 AM</option>
                                <option value="07:00">7:00 AM</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="23:00">11:00 PM</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="sleepTime">Sleep Time Tonight</label>
                        <select id="sleepTime">
                            <option value="20:00">8:00 PM</option>
                            <option value="21:00">9:00 PM</option>
                            <option value="22:00">10:00 PM</option>
                            <option value="23:00">11:00 PM</option>
                            <option value="00:00">12:00 AM</option>
                            <option value="01:00">1:00 AM</option>
                            <option value="02:00">2:00 AM</option>
                        </select>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" id="addDrink">Add Drink</button>
                        <button class="btn btn-secondary" id="resetCalculator">Reset Calculator</button>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2 class="card-title">📊 Results Summary</h2>
                    
                    <div class="results-grid">
                        <div class="result-card" id="totalCard">
                            <div class="result-label">Total Consumed Today</div>
                            <div class="result-value" id="totalConsumed">0</div>
                            <div class="result-unit">mg caffeine</div>
                        </div>
                        <div class="result-card" id="currentCard">
                            <div class="result-label">Remaining Now</div>
                            <div class="result-value" id="currentCaffeine">0</div>
                            <div class="result-unit">mg in system</div>
                        </div>
                        <div class="result-card" id="sleepCard">
                            <div class="result-label">At Sleep Time</div>
                            <div class="result-value" id="sleepCaffeine">0</div>
                            <div class="result-unit">mg projected</div>
                        </div>
                    </div>

                    <div class="warning-message warning-info" id="warningMessage">
                        <span>💡</span>
                        <span>You're within safe caffeine limits. The FDA recommends up to 400mg per day for healthy adults.</span>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">📈 Caffeine Timeline</h2>
                    
                    <div class="chart-container">
                        <canvas id="caffeineChart"></canvas>
                    </div>

                    <div class="custom-legend" id="customLegend"></div>
                </div>

                <div class="card">
                    <h2 class="card-title">📝 Drink History</h2>
                    
                    <div class="drink-history" id="drinkHistory">
                        <p style="color: #a0aec0; text-align: center; padding: 20px;">No drinks added yet. Add your first drink to start tracking!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CaffeineCalculator {
            constructor() {
                this.drinks = [];
                this.chart = null;
                this.updateInterval = null;
                this.hiddenDatasets = new Set();
                this.init();
            }

            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.updateResults();
                this.updateChart();
                this.renderDrinkHistory();
                this.startAutoUpdate();
                this.setDefaultTimes();
            }

            setDefaultTimes() {
                const now = new Date();
                const currentHour = now.getHours();
                document.getElementById('consumptionTime').value = `${currentHour.toString().padStart(2, '0')}:00`;
                document.getElementById('sleepTime').value = '23:00';
            }

            setupEventListeners() {
                document.getElementById('drinkSelect').addEventListener('change', (e) => {
                    const customGroup = document.getElementById('customAmountGroup');
                    if (e.target.value === 'custom') {
                        customGroup.classList.remove('hidden');
                    } else {
                        customGroup.classList.add('hidden');
                    }
                });

                document.getElementById('addDrink').addEventListener('click', () => this.addDrink());
                document.getElementById('resetCalculator').addEventListener('click', () => this.reset());
                document.getElementById('sleepTime').addEventListener('change', () => {
                    this.saveToStorage();
                    this.updateResults();
                });
            }

            addDrink() {
                const drinkSelect = document.getElementById('drinkSelect');
                const quantitySelect = document.getElementById('quantity');
                const daySelect = document.getElementById('consumptionDay');
                const timeSelect = document.getElementById('consumptionTime');
                
                let caffeineAmount = 0;
                let drinkName = '';
                
                if (drinkSelect.value === 'custom') {
                    const customInput = document.getElementById('customAmount');
                    caffeineAmount = parseInt(customInput.value) || 0;
                    drinkName = `Custom (${caffeineAmount}mg)`;
                    
                    if (caffeineAmount <= 0) {
                        alert('Please enter a valid caffeine amount');
                        return;
                    }
                } else {
                    caffeineAmount = parseInt(drinkSelect.value);
                    drinkName = drinkSelect.options[drinkSelect.selectedIndex].text.split(' - ')[0];
                }
                
                const quantity = parseInt(quantitySelect.value);
                const totalCaffeine = caffeineAmount * quantity;
                
                const now = new Date();
                const consumptionDate = new Date(now);
                
                if (daySelect.value === 'tomorrow') {
                    consumptionDate.setDate(consumptionDate.getDate() + 1);
                }
                
                const [hours, minutes] = timeSelect.value.split(':');
                consumptionDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                
                const drink = {
                    id: Date.now(),
                    name: drinkName,
                    caffeine: caffeineAmount,
                    quantity: quantity,
                    totalCaffeine: totalCaffeine,
                    time: consumptionDate.getTime(),
                    timeString: this.formatTime(consumptionDate)
                };
                
                this.drinks.push(drink);
                this.drinks.sort((a, b) => b.time - a.time);
                
                this.saveToStorage();
                this.updateResults();
                this.updateChart();
                this.renderDrinkHistory();
                
                if (drinkSelect.value === 'custom') {
                    document.getElementById('customAmount').value = '';
                }
                
                this.animateAddition();
            }

            removeDrink(drinkId) {
                this.drinks = this.drinks.filter(d => d.id !== drinkId);
                this.saveToStorage();
                this.updateResults();
                this.updateChart();
                this.renderDrinkHistory();
            }

            calculateCaffeineAtTime(drink, targetTime) {
                const hoursElapsed = (targetTime - drink.time) / (1000 * 60 * 60);
                if (hoursElapsed < 0) return 0;
                
                const halfLife = 5;
                const halfLivesElapsed = hoursElapsed / halfLife;
                return drink.totalCaffeine * Math.pow(0.5, halfLivesElapsed);
            }

            updateResults() {
                const now = new Date();
                const startOfDay = new Date(now);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(now);
                endOfDay.setHours(23, 59, 59, 999);
                
                const todaysDrinks = this.drinks.filter(d => 
                    d.time >= startOfDay.getTime() && d.time <= endOfDay.getTime()
                );
                const totalToday = todaysDrinks.reduce((sum, d) => sum + d.totalCaffeine, 0);
                
                let currentCaffeine = 0;
                this.drinks.forEach(drink => {
                    currentCaffeine += this.calculateCaffeineAtTime(drink, now.getTime());
                });
                
                const sleepTimeSelect = document.getElementById('sleepTime');
                const [sleepHours, sleepMinutes] = sleepTimeSelect.value.split(':');
                const sleepTime = new Date(now);
                sleepTime.setHours(parseInt(sleepHours), parseInt(sleepMinutes), 0, 0);
                
                if (sleepTime < now) {
                    sleepTime.setDate(sleepTime.getDate() + 1);
                }
                
                let sleepCaffeine = 0;
                this.drinks.forEach(drink => {
                    sleepCaffeine += this.calculateCaffeineAtTime(drink, sleepTime.getTime());
                });
                
                document.getElementById('totalConsumed').textContent = Math.round(totalToday);
                document.getElementById('currentCaffeine').textContent = Math.round(currentCaffeine);
                document.getElementById('sleepCaffeine').textContent = Math.round(sleepCaffeine);
                
                this.updateCardColors(totalToday, currentCaffeine, sleepCaffeine);
                this.updateWarningMessage(totalToday, sleepCaffeine);
                
                document.querySelectorAll('.result-card').forEach(card => {
                    card.classList.add('updating');
                    setTimeout(() => card.classList.remove('updating'), 1000);
                });
            }

            updateCardColors(total, current, sleep) {
                const totalCard = document.getElementById('totalCard');
                const currentCard = document.getElementById('currentCard');
                const sleepCard = document.getElementById('sleepCard');
                
                totalCard.className = 'result-card';
                currentCard.className = 'result-card';
                sleepCard.className = 'result-card';
                
                if (total <= 200) {
                    totalCard.classList.add('safe-green');
                    currentCard.classList.add('safe-green');
                } else if (total <= 300) {
                    totalCard.classList.add('safe-blue');
                    currentCard.classList.add('safe-blue');
                } else if (total <= 400) {
                    totalCard.classList.add('warning-orange');
                    currentCard.classList.add('warning-orange');
                } else {
                    totalCard.classList.add('danger-red');
                    currentCard.classList.add('danger-red');
                }
                
                if (sleep <= 25) {
                    sleepCard.classList.add('safe-green');
                } else if (sleep <= 50) {
                    sleepCard.classList.add('safe-blue');
                } else if (sleep <= 100) {
                    sleepCard.classList.add('warning-orange');
                } else {
                    sleepCard.classList.add('danger-red');
                }
            }

            updateWarningMessage(total, sleep) {
                const warningDiv = document.getElementById('warningMessage');
                warningDiv.className = 'warning-message';
                
                if (total > 400 || sleep > 100) {
                    warningDiv.classList.add('warning-alert');
                    warningDiv.innerHTML = `
                        <span>⚠️</span>
                        <span>${total > 400 ? 
                            `Exceeded daily limit! You've consumed ${Math.round(total)}mg (FDA recommends max 400mg).` : 
                            `High caffeine at bedtime! Projected ${Math.round(sleep)}mg at sleep (recommended <50mg).`}</span>
                    `;
                } else if (total > 300 || sleep > 50) {
                    warningDiv.classList.add('warning-caution');
                    warningDiv.innerHTML = `
                        <span>⚡</span>
                        <span>${total > 300 ? 
                            `Approaching daily limit. You've consumed ${Math.round(total)}mg of 400mg recommended.` : 
                            `Moderate caffeine at bedtime. Consider earlier consumption for better sleep.`}</span>
                    `;
                } else {
                    warningDiv.classList.add('warning-info');
                    warningDiv.innerHTML = `
                        <span>💡</span>
                        <span>You're within safe caffeine limits. The FDA recommends up to 400mg per day for healthy adults.</span>
                    `;
                }
            }

            updateChart() {
                const ctx = document.getElementById('caffeineChart').getContext('2d');
                const now = new Date();
                const startTime = now.getTime() - (6 * 60 * 60 * 1000);
                const endTime = now.getTime() + (30 * 60 * 60 * 1000);
                
                const timePoints = [];
                const timeLabels = [];
                for (let t = startTime; t <= endTime; t += 30 * 60 * 1000) {
                    timePoints.push(t);
                    const date = new Date(t);
                    const hours = date.getHours();
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
                    timeLabels.push(`${displayHours}${ampm}`);
                }
                
                const datasets = [];
                
                const totalData = timePoints.map(t => {
                    let total = 0;
                    this.drinks.forEach(drink => {
                        total += this.calculateCaffeineAtTime(drink, t);
                    });
                    return Math.round(total);
                });
                
                datasets.push({
                    label: 'Total Caffeine',
                    data: totalData,
                    borderColor: 'rgb(102, 126, 234)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true
                });
                
                this.drinks.forEach((drink, index) => {
                    const drinkData = timePoints.map(t => {
                        return Math.round(this.calculateCaffeineAtTime(drink, t));
                    });
                    
                    const hue = (index * 360 / this.drinks.length) % 360;
                    datasets.push({
                        label: `${drink.name} (${drink.timeString})`,
                        data: drinkData,
                        borderColor: `hsl(${hue}, 70%, 50%)`,
                        backgroundColor: `hsla(${hue}, 70%, 50%, 0.1)`,
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false
                    });
                });
                
                const limitData = new Array(timePoints.length).fill(400);
                const sleepWarningData = new Array(timePoints.length).fill(100);
                const sleepSafeData = new Array(timePoints.length).fill(50);
                
                datasets.push({
                    label: 'FDA Daily Limit (400mg)',
                    data: limitData,
                    borderColor: 'rgb(245, 101, 101)',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
                
                datasets.push({
                    label: 'Sleep Warning (100mg)',
                    data: sleepWarningData,
                    borderColor: 'rgb(237, 137, 54)',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
                
                datasets.push({
                    label: 'Sleep Safe (50mg)',
                    data: sleepSafeData,
                    borderColor: 'rgb(72, 187, 120)',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false
                });
                
                if (this.chart) {
                    this.chart.destroy();
                }
                
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14
                                },
                                bodyFont: {
                                    size: 12
                                },
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y + 'mg';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    maxTicksLimit: 12,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                display: true,
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value + 'mg';
                                    }
                                }
                            }
                        }
                    }
                });
                
                datasets.forEach((dataset, index) => {
                    if (this.hiddenDatasets.has(index)) {
                        this.chart.setDatasetVisibility(index, false);
                    }
                });
                
                this.updateCustomLegend(datasets);
            }

            updateCustomLegend(datasets) {
                const legendContainer = document.getElementById('customLegend');
                legendContainer.innerHTML = '';
                
                datasets.forEach((dataset, index) => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    if (this.hiddenDatasets.has(index)) {
                        legendItem.classList.add('hidden');
                    }
                    
                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = dataset.borderColor;
                    if (dataset.borderDash) {
                        colorBox.style.border = `1px dashed ${dataset.borderColor}`;
                        colorBox.style.backgroundColor = 'transparent';
                    }
                    
                    const label = document.createElement('span');
                    label.textContent = dataset.label;
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    
                    legendItem.addEventListener('click', () => {
                        const isVisible = this.chart.isDatasetVisible(index);
                        this.chart.setDatasetVisibility(index, !isVisible);
                        
                        if (!isVisible) {
                            this.hiddenDatasets.delete(index);
                            legendItem.classList.remove('hidden');
                        } else {
                            this.hiddenDatasets.add(index);
                            legendItem.classList.add('hidden');
                        }
                        
                        this.chart.update();
                    });
                    
                    legendContainer.appendChild(legendItem);
                });
            }

            renderDrinkHistory() {
                const historyContainer = document.getElementById('drinkHistory');
                
                if (this.drinks.length === 0) {
                    historyContainer.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">No drinks added yet. Add your first drink to start tracking!</p>';
                    return;
                }
                
                historyContainer.innerHTML = '';
                
                this.drinks.forEach(drink => {
                    const drinkItem = document.createElement('div');
                    drinkItem.className = 'drink-item';
                    
                    drinkItem.innerHTML = `
                        <div class="drink-info">
                            <div class="drink-name">${drink.name} ${drink.quantity > 1 ? `x${drink.quantity}` : ''}</div>
                            <div class="drink-details">${drink.totalCaffeine}mg • ${drink.timeString}</div>
                        </div>
                        <button class="btn btn-danger" onclick="calculator.removeDrink(${drink.id})">Remove</button>
                    `;
                    
                    historyContainer.appendChild(drinkItem);
                });
            }

            formatTime(date) {
                const options = {
                    weekday: 'short',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                };
                return date.toLocaleString('en-US', options);
            }

            reset() {
                if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
                    this.drinks = [];
                    this.hiddenDatasets.clear();
                    localStorage.removeItem('caffeineCalculatorData');
                    this.updateResults();
                    this.updateChart();
                    this.renderDrinkHistory();
                }
            }

            saveToStorage() {
                const data = {
                    drinks: this.drinks,
                    sleepTime: document.getElementById('sleepTime').value
                };
                localStorage.setItem('caffeineCalculatorData', JSON.stringify(data));
            }

            loadFromStorage() {
                const stored = localStorage.getItem('caffeineCalculatorData');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        this.drinks = data.drinks || [];
                        if (data.sleepTime) {
                            document.getElementById('sleepTime').value = data.sleepTime;
                        }
                    } catch (e) {
                        console.error('Failed to load data:', e);
                    }
                }
            }

            startAutoUpdate() {
                this.updateInterval = setInterval(() => {
                    this.updateResults();
                }, 60000);
            }

            animateAddition() {
                const cards = document.querySelectorAll('.result-card');
                cards.forEach(card => {
                    card.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        card.style.transform = 'scale(1)';
                    }, 300);
                });
            }
        }

        const calculator = new CaffeineCalculator();
    </script>
</body>
</html>